// pages/policy/policy.js
var page = 1;
var province = '', city = '', district = '', department = '', title = '', sortBy='1',onlyTitle=true;
Page({

  /**
   * 页面的初始数据
   */
  data: {
    totalNum: 0,
    isHideLoadMore: false,
    isHiddenFilterView: true,
    totalNum: 0,
    dataList: [],
    provinceList: [],
    cityList: [],
    districtList: [],
    departmentList: [],
    selProvince: '',
    selCity: '',
    selDistrict: '',
    selDepartment: ''
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
    let that = this;
    //获取默认数据
    wx.request({
      method: 'GET',
      data: {
        pageNum: page,
        flag: '1',
        pageSize: 20
      },
      url: 'https://app.techhg.com/granoti/list',
      success: function (res) {
        // console.log(res.data);
        that.setData({
          dataList: res.data.body.list,
          totalNum: res.data.body.total
        })
      }
    })
    // 获取筛选列表
    wx.request({
      url: 'https://app.techhg.com/base/listDept2ByAddr',
      method: 'GET',
      data: {
        addrCode: 0
      },
      success: function (res) {
        console.log(res.data);
        that.setData({
          provinceList: res.data.body
        })
      }
    })
  },
  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function () {

  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function () {

  },

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function () {

  },

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function () {

  },

  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh: function () {
    console.log("下拉刷新事件 系统");
    wx.showNavigationBarLoading() //在标题栏中显示加载
    // wx.hideNavigationBarLoading() //完成停止加载
    wx.stopPullDownRefresh() //停止下拉刷新
  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function () {
    var dataBefore = this.data.dataList;
    console.log("上拉加载更多事件 系统");
    let that = this;
    var dataListBefore = that.data.dataList;
    page++;

    wx.request({
      method: 'GET',
      data: {
        pageNum: page,
        flag: '',
        pageSize: 20
      },
      header: {
        'content-type': 'application/json'
      },
      url: 'https://app.techhg.com/granoti/list',
      success: function (res) {

        console.log(res.data.body.pageNum);
        that.setData({
          isHideLoadMore: true,
          dataList: dataListBefore.concat(res.data.body.list),
        })
      }
    })
  },

  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function () {

  },

  // 用户自定义事件
  tableViewItemClick: function (e) {
    // var index = parseInt(e.currentTarget.dataset);
    console.log("点击了" + e.currentTarget.dataset.title);

    wx.navigateTo({
      url: '../policydetail/policydetail?id=' + e.currentTarget.dataset.id + '&addr=' +
      e.currentTarget.dataset.addr + '&source=' + e.currentTarget.dataset.source + '&title=' + e.currentTarget.dataset.title
    })
  },
  // 排序
  softClick: function () {
    console.log("点击事件"),
      this.setData({
        isHiddenFilterView: false
      })
  },
  // 筛选页省级点击目录
  provinceTap: function (e) {
    console.log("点击选择省级" + e.currentTarget.dataset.index)
    var index = e.currentTarget.dataset.index
    this.setData({
      cityList: this.data.provinceList[index].listAddr,
      departmentList: this.data.provinceList[index].listDept,
      districtList: [],
      selProvince: this.data.provinceList[index].addrName,
      selCity: '',
      selDistrict: '',
      selDepartment: ''
    });
  },
  // 筛选页市级点击目录
  cityTap: function (e) {
    console.log("点击选择市级" + e.currentTarget.dataset.index)
    var index = e.currentTarget.dataset.index
    this.setData({
      districtList: this.data.cityList[index].listAddr,
      departmentList: this.data.cityList[index].listDept,
      selCity: this.data.cityList[index].addrName,
      selDistrict: '',
      selDepartment: ''
    });
  },
  districtTap: function (e) {
    console.log("点击选择市级" + e.currentTarget.dataset.index)
    var index = e.currentTarget.dataset.index
    this.setData({
      departmentList: this.data.districtList[index].listDept,
      selDistrict: this.data.districtList[index].addrName,
      selDepartment: ''
    });
  },
  departmentTap: function (e) {
    console.log("点击选择部门" + e.currentTarget.dataset.index)
    var index = e.currentTarget.dataset.index
    this.setData({
      selDepartment: this.data.departmentList[index].departName,
    });
  },
  //关闭筛选页
  closeFilter: function () {
    this.setData({
      isHiddenFilterView: true
    })
  },
  filterSure: function () {
    province = this.data.selProvince;
    city = this.data.selCity;
    district = this.data.selDistrict;
    department = this.data.selDepartment;
    this.loadData();
  },
  loadData: function () {
    console.log("加载数据");
    this.setData({
      isHiddenFilterView: true
    })
    page = 1;
    let that = this;
    if (province == '' && city == '' && district == '' && department == '' && title == '') {
      //获取默认数据
      wx.request({
        method: 'GET',
        data: {
          pageNum: page,
          flag: '1',
          pageSize: 20
        },
        url: 'https://app.techhg.com/granoti/list',
        success: function (res) {
          // console.log(res.data);
          that.setData({
            dataList: res.data.body.list,
            totalNum: res.data.body.total
          })
        }
      })
    }
    else {
      var addr;
      if(district!=''){
        addr = district;
      }
      else
      {
        if(city!=''){
          addr = city;
        }
        else
        {
          addr = province;
        }
      }
      wx.request({
        method: 'GET',
        data: {
          pageNum: page,
          flag: sortBy,
          pageSize: 20,
          notEqual: "",
          addr: addr,
          source: department,
          title: title,
          info: onlyTitle?'':title,
          sourceType: '',
          dim: title,
        },
        url: 'https://app.techhg.com/granoti/listNew',
        success: function (res) {
          // console.log(res.data);
          that.setData({
            dataList: res.data.body.list,
            totalNum: res.data.body.total
          })
        }
      })
    }
  }


})